{"data":{"markdownRemark":{"html":"<p>In this post, we will be creating a simple scalable dashboard that updates in real-time using <a href=\"ll\">React</a>, <a href=\"ll\">GraphQL Subscriptions</a> and <a href=\"ll\">Redis PubSub</a>. Real-time dashboards can be used to monitor your <strong>infrastructure</strong> (servers, network, services), <strong>application traffic</strong> (transaction volume, number of users), <strong>alerts</strong> (application health, critical issues, downtimes) etc. Almost always, dashboards are backed up with one or more datasources.</p>\n<p>There are many open-source applications that can be used to create dashboards. For example, <strong><a href=\"ll\">Kibana</a></strong> can be used to visualize application logs integrated with <a href=\"ll\">ELK Stack</a>. <strong><a href=\"ll\">Grafana</a></strong> can be used to create a variety of visualizations on top of time series databases such as <a href=\"ll\">Prometheus</a>, <a href=\"ll\">Graphite</a> and <a href=\"ll\">OpenTSDB</a>. But, as of today, they support <a href=\"https://en.wikipedia.org/wiki/Pull_technology\">pull-based model</a>. That is, when a user opens the browser, application makes the queries and result is rendered. It is the most widely used model as opposed to a <a href=\"https://en.wikipedia.org/wiki/Push_technology\">Push model</a>. </p>\n<h2>When push-model can be used?</h2>\n<p>Assume you have a dashboard containing <strong><em>20 panels</em></strong>, querying data from multiple datasources at the backend in real-time. User has set a refresh rate of <strong><em>5 seconds</em></strong>. If, on an average <strong><em>100 users</em></strong> open the dashboard at any time - that is <strong><em>20 x 100 = 2000 requests</em></strong> every 5 seconds! This is manageable if you have good infrastructure for your underlying time-series database. Multiple Heavy queries can pile-up the memory. This problem can be solved either by introducing some intelligent caching, or a simple push-model using <a href=\"ll\">WebSockets</a>. It is useful (and simple), for the situation where multiple users are querying for the same data, at same or slightly-different time. </p>\n<ul>\n<li>Connection is established between server and client using WebSocket.</li>\n<li>Server sends the required data to Client at regular intervals</li>\n<li>If the connection breaks, client can retry indefinitely.</li>\n</ul>\n<h3>What are we building?</h3>\n<p>Here's the preview of a simple real-time dashboard we will be building. It contains 4 panels - CPU Utilization, Traffic information, Data-center distribution and alerts.</p>\n<img src=\"/demo-c4fc92aed4a93e02edf4e7e71dd700e5.gif\" alt=\"Real-time dashboard preview\" style=\"border: 1px solid #000;\">\n<h2>GraphQL Subscriptions</h2>\n<p><a href=\"ll\">GraphQL</a> is a query language for APIs and a runtime for fulfilling those queries with your existing data. Check out <a href=\"https://graphql.org/\">graphql.org</a> for more info if you are not familiar with GraphQL.</p>\n<p>Along with <a href=\"ll\">queries</a> and <a href=\"ll\">mutations</a>, GraphQL introduced one more specification - <a href=\"ll\">Subscriptions</a>. </p>\n<blockquote>\n<p> just as the list of mutations that the server supports describes all of the actions that a client can take, the list of subscriptions that the server supports describes all of the events that it can subscribe to. Just as a client can tell the server what data to refetch after it performs a mutation with a GraphQL selection, the client can tell the server what data it wants to be pushed with the subscription with a GraphQL selection. - <a href=\"https://graphql.org/blog/subscriptions-in-graphql-and-relay/\">GraphQL blog</a></p>\n</blockquote>\n<p>For example, client can subscribe for CPU data using the following subscription syntax</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-graphql line-numbers\"><code class=\"language-graphql\">subscription CPU <span class=\"token punctuation\">{</span>\n  cpu <span class=\"token punctuation\">{</span>\n    percentage\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Server can publish the data at regular intervals,</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">pubsub<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CPU</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> cpu<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> percentage<span class=\"token punctuation\">:</span> <span class=\"token number\">65</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h2>Redis PubSub</h2>\n<p>Since version 2.0, Redis supports <a href=\"http://en.wikipedia.org/wiki/Publish/subscribe\">Publish-Subscribe pattern</a> using commands <a href=\"https://redis.io/commands/publish\">PUBLISH</a>, <a href=\"https://redis.io/commands/subscribe\">SUBSCRIBE</a> and <a href=\"https://redis.io/commands/unsubscribe\">UNSUBSCRIBE</a>. Read more about it from <a href=\"https://redis.io/topics/pubsub\">Redis Documentation</a>.</p>\n<p>Message can be published via <strong>channels</strong>. If we want to send message <code class=\"language-text\">&quot;hello listeners&quot;</code> via channel <code class=\"language-text\">myradio</code>, simply use the <code class=\"language-text\">PUBLISH</code> command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">PUBLISH myradio <span class=\"token string\">\"hello listeners\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>But, a channel is useless if nobody is listening on the other side! Open another tab with <code class=\"language-text\">redis-cli</code> and subscribe to the channel <code class=\"language-text\">myradio</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">SUBSCRIBE myradio</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Now, send the publish command again and watch for the same in the other terminal</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4954734d475d7e5ea62d214bf7942fbe/2a77b/redis-pubsub-terminal.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 29.639639639639636%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA7klEQVQY03WQy4qEQAxFyxe+EFtae6EbQUUFdeFPuGhQG18LN/7/T9yehNFhhunFIVW3cpNUxL7vOI4DFNd1ZeZ5xrIsDJ3HcWSmacK2bZi+tGEY8Hq90Pc9ns8nuq5jRJ7nIB6PB+73O8fb7QbbtuG6LjzPg6IoEELwW1VVKMuS9SAI4Ps+DMOAqqqcI4qiQJqmiOOYDZqmQdf1C0q2LAuyLCOKItR1jSRJ2EzaCfm4MV0kSfoRqMsHqGDbtsiy7GpCOvmvyOK3cIr/QW9hGKJpGp6QVmKa5q+inEdTfSrytyDtzXGcC9r1+asz5w1JPJcuRbYSbwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Redis PubSub in terminal\"\n        title=\"\"\n        src=\"/static/4954734d475d7e5ea62d214bf7942fbe/40fad/redis-pubsub-terminal.png\"\n        srcset=\"/static/4954734d475d7e5ea62d214bf7942fbe/707e9/redis-pubsub-terminal.png 148w,\n/static/4954734d475d7e5ea62d214bf7942fbe/649e0/redis-pubsub-terminal.png 295w,\n/static/4954734d475d7e5ea62d214bf7942fbe/40fad/redis-pubsub-terminal.png 590w,\n/static/4954734d475d7e5ea62d214bf7942fbe/b3fef/redis-pubsub-terminal.png 885w,\n/static/4954734d475d7e5ea62d214bf7942fbe/2a77b/redis-pubsub-terminal.png 1110w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<h3>Combining GraphQL subscription &#x26; Redis PubSub</h3>\n<p>We can implement GraphQL subscription specification using <a href=\"https://www.apollographql.com/\">Apollo</a>'s package - <a href=\"https://github.com/apollographql/graphql-subscriptions\">graphql-subscriptions</a>. </p>\n<p>Using Redis as mediator for publishing events from client to server enables us horizontally scale. We can plug in <a href=\"https://github.com/davidyaha/graphql-redis-subscriptions\">graphql-redis-subscriptions</a> as PubSubEngine interface to <code class=\"language-text\">graphql-subscriptions</code>.</p>\n<h2>Sample Implementation</h2>\n<p>For full implementation - see <a href=\"https://github.com/nowke/realtime-dashboard-demo/\">github.com/nowke/realtime-dashboard-demo/</a>. We will look at the important parts here.</p>\n<p>We're going to build 3 components</p>\n<ul>\n<li>Server</li>\n<li>Client - user's browser, connects to server</li>\n<li>Worker - mocks real events by publishing events to server</li>\n</ul>\n<h3>Server</h3>\n<p>Install the required pacakges</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">yarn add graphql apollo-server graphql-redis-subscriptions graphql-subscriptions ioredis moment</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>If you have <code class=\"language-text\">redis-server</code> running in local at <code class=\"language-text\">PORT 6379</code>, setup the PubSub using <code class=\"language-text\">graphql-redis-subscriptions</code>. We will use it to publish messages</p>\n<p><strong><a href=\"https://github.com/nowke/realtime-dashboard-demo/blob/master/server/pubsub.js\"><code class=\"language-text\">server/pubsub.js</code></a></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> RedisPubSub <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"graphql-redis-subscriptions\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> pubsub <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisPubSub</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> pubsub<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Define the GraphQL schema. We use,</p>\n<ul>\n<li><strong>Query</strong> - for getting initial result from Redis</li>\n<li><strong>Mutation</strong> - to publish new messages</li>\n<li><strong>Subscription</strong> - websocket connection between client and server for real-time updating the graphs</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> gql <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"apollo-server\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  type Dps {\n    timestamp: Int!\n    value: Float!\n  }\n\n  type Traffic {\n    total: Int!\n    dps: [Dps]\n  }\n\n  type CPU {\n    percentage: Float!\n  }\n\n  type Distribution {\n    region: String!\n    percentage: Float!\n  }\n\n  type Message {\n    title: String!\n    description: String!\n    color: String!\n  }\n\n  type Query {\n    cpu: CPU\n    traffic: Traffic\n    distribution: [Distribution]\n    messages: [Message]\n  }\n\n  type Mutation {\n    cpu: CPU\n    traffic: Traffic\n    distribution: [Distribution]\n    messages: [Message]\n  }\n\n  type Subscription {\n    cpu: CPU\n    traffic: Traffic\n    distribution: [Distribution]\n    messages: [Message]\n  }\n`</span></span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> schema<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","frontmatter":{"title":"Real-time Dashboard"}}},"pageContext":{"slug":"/realtime-dashboard/"}}