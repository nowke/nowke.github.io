{"data":{"markdownRemark":{"html":"<p>In this post, we will be creating a simple scalable dashboard that updates in real-time using <a href=\"ll\">React</a>, <a href=\"ll\">GraphQL Subscriptions</a>, and <a href=\"ll\">Redis PubSub</a>. Real-time dashboards are used for monitoring <strong>infrastructure</strong> (servers, network, services), <strong>application traffic</strong> (transaction volume, number of users), <strong>alerts</strong> (application health, notify of critical issues, downtimes) etc. In most cases, dashboards are driven by one or more datasources.</p>\n<p>Developers utilize a few open-source applications to create rich and useful dashboards. For example, <strong><a href=\"ll\">Kibana</a></strong> is used for visualizing application logs integrated with <a href=\"ll\">ELK Stack</a>. <strong><a href=\"ll\">Grafana</a></strong> provides the platform for building variety of visualizations on top of time series databases such as <a href=\"ll\">Prometheus</a>, <a href=\"ll\">Graphite</a>, and <a href=\"ll\">OpenTSDB</a>. But, as of today, they support only <a href=\"https://en.wikipedia.org/wiki/Pull_technology\">pull-based model</a>. That is, when a user opens the browser, the application queries the datasource to render the dashboard. It is the most widely used model as compared to a <a href=\"https://en.wikipedia.org/wiki/Push_technology\">Push model</a>. </p>\n<h2>When push-model can be used?</h2>\n<p>Assume you have a dashboard consisting of <strong><em>20 panels</em></strong>; querying data from multiple datasources in real-time. The User has set a refresh rate of <strong><em>5 seconds</em></strong>. If, on an average <strong><em>100 users</em></strong> open the dashboard at any given time results in <strong><em>20 x 100 = 2000 requests</em></strong> every 5 seconds! This is manageable if you have good infrastructure for your underlying time-series database. Otherwise multiple heavy queries can pile-up the memory causing delay in retrieving result. This problem can be solved either by introducing an intelligent caching solution, or a simple push-model using <a href=\"ll\">WebSockets</a>. It is useful (and simple), for the situation where multiple users are querying for the same data, at the same or slightly-different time. </p>\n<p>Here's a minimal flow of how push-model can work:</p>\n<ul>\n<li>A Connection is established between server and client using WebSocket.</li>\n<li>Server sends the required data to client at regular intervals</li>\n<li>If the connection breaks, the client can retry (even indefinitely).</li>\n<li>At any given point of time, all clients display the same data</li>\n</ul>\n<h3>What are we building?</h3>\n<p>Here's the preview of a simple real-time dashboard we will be building. It contains 4 panels - CPU Utilization, Traffic information, Data-center distribution, and alerts.</p>\n<img src=\"/demo-c4fc92aed4a93e02edf4e7e71dd700e5.gif\" alt=\"Real-time dashboard preview\" style=\"border: 1px solid #000;\">\n<h2>GraphQL Subscriptions</h2>\n<p><a href=\"ll\">GraphQL</a> is a query language for APIs and a runtime for fulfilling those queries with your existing data. Check out <a href=\"https://graphql.org/\">graphql.org</a> for more info if you are not familiar with GraphQL.</p>\n<p>Along with <a href=\"ll\">queries</a> and <a href=\"ll\">mutations</a>, GraphQL introduced another specification - <a href=\"ll\">Subscriptions</a>. </p>\n<blockquote>\n<p> just as the list of mutations that the server supports describes all of the actions that a client can take, the list of subscriptions that the server supports describes all of the events that it can subscribe to. Just as a client can tell the server what data to refetch after it performs a mutation with a GraphQL selection, the client can tell the server what data it wants to be pushed with the subscription with a GraphQL selection. - <a href=\"https://graphql.org/blog/subscriptions-in-graphql-and-relay/\">GraphQL blog</a></p>\n</blockquote>\n<p>For example, the client can subscribe for CPU data using the following subscription syntax</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-graphql line-numbers\"><code class=\"language-graphql\">subscription CPU <span class=\"token punctuation\">{</span>\n  cpu <span class=\"token punctuation\">{</span>\n    percentage\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Server can publish data at regular intervals,</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\">pubsub<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CPU</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> cpu<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> percentage<span class=\"token punctuation\">:</span> <span class=\"token number\">65</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h2>Redis PubSub</h2>\n<p>Since version 2.0, <a href=\"ll\">Redis</a> supports <a href=\"http://en.wikipedia.org/wiki/Publish/subscribe\">Publish-Subscribe pattern</a> using commands <a href=\"https://redis.io/commands/publish\">PUBLISH</a>, <a href=\"https://redis.io/commands/subscribe\">SUBSCRIBE</a> and <a href=\"https://redis.io/commands/unsubscribe\">UNSUBSCRIBE</a>. Read more about it from <a href=\"https://redis.io/topics/pubsub\">Redis Documentation</a>.</p>\n<p>Messages can be published via <strong>channels</strong>. To send the message <code class=\"language-text\">&quot;hello listeners&quot;</code> via channel <code class=\"language-text\">myradio</code> - use the <code class=\"language-text\">PUBLISH</code> command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">PUBLISH myradio <span class=\"token string\">\"hello listeners\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>But, a channel is useless with nobody to listen! Open another tab with <code class=\"language-text\">redis-cli</code> and subscribe to the channel <code class=\"language-text\">myradio</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">SUBSCRIBE myradio</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Now, send the publish command again and watch the other terminal.</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4954734d475d7e5ea62d214bf7942fbe/2a77b/redis-pubsub-terminal.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 29.639639639639636%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA7klEQVQY03WQy4qEQAxFyxe+EFtae6EbQUUFdeFPuGhQG18LN/7/T9yehNFhhunFIVW3cpNUxL7vOI4DFNd1ZeZ5xrIsDJ3HcWSmacK2bZi+tGEY8Hq90Pc9ns8nuq5jRJ7nIB6PB+73O8fb7QbbtuG6LjzPg6IoEELwW1VVKMuS9SAI4Ps+DMOAqqqcI4qiQJqmiOOYDZqmQdf1C0q2LAuyLCOKItR1jSRJ2EzaCfm4MV0kSfoRqMsHqGDbtsiy7GpCOvmvyOK3cIr/QW9hGKJpGp6QVmKa5q+inEdTfSrytyDtzXGcC9r1+asz5w1JPJcuRbYSbwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Redis PubSub in terminal\"\n        title=\"\"\n        src=\"/static/4954734d475d7e5ea62d214bf7942fbe/40fad/redis-pubsub-terminal.png\"\n        srcset=\"/static/4954734d475d7e5ea62d214bf7942fbe/707e9/redis-pubsub-terminal.png 148w,\n/static/4954734d475d7e5ea62d214bf7942fbe/649e0/redis-pubsub-terminal.png 295w,\n/static/4954734d475d7e5ea62d214bf7942fbe/40fad/redis-pubsub-terminal.png 590w,\n/static/4954734d475d7e5ea62d214bf7942fbe/b3fef/redis-pubsub-terminal.png 885w,\n/static/4954734d475d7e5ea62d214bf7942fbe/2a77b/redis-pubsub-terminal.png 1110w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<h3>Combining GraphQL subscription &#x26; Redis PubSub</h3>\n<p>GraphQL subscription specification can be implemented using <a href=\"https://www.apollographql.com/\">Apollo</a>'s package - <a href=\"https://github.com/apollographql/graphql-subscriptions\">graphql-subscriptions</a>. </p>\n<p>Using Redis as a mediator for publishing events from client to server enables horizontal scaling. The package <a href=\"https://github.com/davidyaha/graphql-redis-subscriptions\">graphql-redis-subscriptions</a> can be plugged as a PubSubEngine interface to <code class=\"language-text\">graphql-subscriptions</code>.</p>\n<h2>Sample Implementation</h2>\n<p>For full implementation - see <a href=\"https://github.com/nowke/realtime-dashboard-demo/\">github.com/nowke/realtime-dashboard-demo/</a>. We will look at the important parts here.</p>\n<p>We're going to build 3 components</p>\n<ul>\n<li>Server</li>\n<li>Client - user's browser, connects to the server</li>\n<li>Worker - mocks real events by publishing events to the server</li>\n</ul>\n<h3>Server</h3>\n<p>Install the required pacakges</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">yarn add graphql apollo-server graphql-redis-subscriptions graphql-subscriptions ioredis moment</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>If you have <code class=\"language-text\">redis-server</code> running in local at <code class=\"language-text\">PORT 6379</code>, setup the PubSub using <code class=\"language-text\">graphql-redis-subscriptions</code>. We will use it to publish messages</p>\n<p><strong><a href=\"https://github.com/nowke/realtime-dashboard-demo/blob/master/server/pubsub.js\"><code class=\"language-text\">server/pubsub.js</code></a></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> RedisPubSub <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"graphql-redis-subscriptions\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> pubsub <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisPubSub</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> pubsub<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Define the GraphQL schema. We use,</p>\n<ul>\n<li><strong>Query</strong> - for getting the initial result from Redis</li>\n<li><strong>Mutation</strong> - to publish new messages</li>\n<li><strong>Subscription</strong> - websocket connection between client and server for real-time updating the graphs</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-graphql line-numbers\"><code class=\"language-graphql\">const <span class=\"token punctuation\">{</span> gql <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"apollo-server\"</span><span class=\"token punctuation\">)</span>;\n\nconst schema <span class=\"token operator\">=</span> gql`\n  type Dps <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">timestamp</span><span class=\"token punctuation\">:</span> Int<span class=\"token operator\">!</span>\n    <span class=\"token attr-name\">value</span><span class=\"token punctuation\">:</span> Float<span class=\"token operator\">!</span>\n  <span class=\"token punctuation\">}</span>\n\n  type Traffic <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">total</span><span class=\"token punctuation\">:</span> Int<span class=\"token operator\">!</span>\n    <span class=\"token attr-name\">dps</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Dps<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  type CPU <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">percentage</span><span class=\"token punctuation\">:</span> Float<span class=\"token operator\">!</span>\n  <span class=\"token punctuation\">}</span>\n\n  type Distribution <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">region</span><span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span>\n    <span class=\"token attr-name\">percentage</span><span class=\"token punctuation\">:</span> Float<span class=\"token operator\">!</span>\n  <span class=\"token punctuation\">}</span>\n\n  type Message <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">title</span><span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span>\n    <span class=\"token attr-name\">description</span><span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span>\n    <span class=\"token attr-name\">color</span><span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span>\n  <span class=\"token punctuation\">}</span>\n\n  type Query <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">cpu</span><span class=\"token punctuation\">:</span> CPU\n    <span class=\"token attr-name\">traffic</span><span class=\"token punctuation\">:</span> Traffic\n    <span class=\"token attr-name\">distribution</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Distribution<span class=\"token punctuation\">]</span>\n    <span class=\"token attr-name\">messages</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Message<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  type Mutation <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">cpu</span><span class=\"token punctuation\">:</span> CPU\n    <span class=\"token attr-name\">traffic</span><span class=\"token punctuation\">:</span> Traffic\n    <span class=\"token attr-name\">distribution</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Distribution<span class=\"token punctuation\">]</span>\n    <span class=\"token attr-name\">messages</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Message<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  type Subscription <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">cpu</span><span class=\"token punctuation\">:</span> CPU\n    <span class=\"token attr-name\">traffic</span><span class=\"token punctuation\">:</span> Traffic\n    <span class=\"token attr-name\">distribution</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Distribution<span class=\"token punctuation\">]</span>\n    <span class=\"token attr-name\">messages</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Message<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n`;\n\nmodule.exports <span class=\"token operator\">=</span> schema;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>I have provided helper functions to generate dummy data for all 4 panels. Refer <a href=\"https://github.com/nowke/realtime-dashboard-demo/blob/master/server/utils/generator.js\"><code class=\"language-text\">server/utils/generator.js</code></a>. Using these functions, let's write a function <code class=\"language-text\">publishRandomData</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> pubsub <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./pubsub\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./utils/redis\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">COMPONENTS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">CPU</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"cpu\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">TRAFFIC</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"traffic\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">DISTRIBUTION</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"distribution\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">MESSAGES</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"messages\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> publishRandomData <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>generator<span class=\"token punctuation\">,</span> component<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token function\">generator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  pubsub<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span>component<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>component<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> data <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>component<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>We can call this function for CPU usage as below</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getCPU</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token number\">50</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">await</span> <span class=\"token function\">publishRandomData</span><span class=\"token punctuation\">(</span>getCPU<span class=\"token punctuation\">,</span> <span class=\"token string\">\"CPU\"</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Define the resolver functions for the schema we wrote earlier (sample for CPU)</p>\n<p><strong><a href=\"https://github.com/nowke/realtime-dashboard-demo/blob/master/server/resolvers.js\"><code class=\"language-text\">server/resolvers.js</code></a></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./utils/redis\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Query<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    cpu<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token constant\">COMPONENTS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CPU</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  Mutation<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    cpu<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">publishRandomData</span><span class=\"token punctuation\">(</span>cpuData<span class=\"token punctuation\">,</span> <span class=\"token constant\">COMPONENTS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CPU</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  Subscription<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    cpu<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      subscribe<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> pubsub<span class=\"token punctuation\">.</span><span class=\"token function\">asyncIterator</span><span class=\"token punctuation\">(</span><span class=\"token constant\">COMPONENTS</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CPU</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Start the server</p>\n<p><strong><a href=\"https://github.com/nowke/realtime-dashboard-demo/blob/master/server/index.js\"><code class=\"language-text\">server/index.js</code></a></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ApolloServer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"apollo-server\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> typeDefs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./schema\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> resolvers <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./resolvers\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Server</span>\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> typeDefs<span class=\"token punctuation\">,</span> resolvers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`🚀  Server ready at </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ yarn start\nyarn run v1.13.0\n$ nodemon index.js\n...\n🚀  Server ready at http://localhost:4000/</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Go to <a href=\"http://localhost:4000/\">localhost:4000</a> to open GraphQL playground.</p>\n<p>Subscribe to CPU percentage in <strong>Tab 1</strong> and hit the play button</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-graphql line-numbers\"><code class=\"language-graphql\">subscription <span class=\"token punctuation\">{</span>\n  cpu <span class=\"token punctuation\">{</span>\n    percentage\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Run the mutation for CPU in <strong>Tab 2</strong>, to publish random percentage value. You should receive the value as an event in <strong>Tab 1</strong>. Try the mutation multiple times to receive different values.</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-graphql line-numbers\"><code class=\"language-graphql\"><span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  cpu <span class=\"token punctuation\">{</span>\n    percentage\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Run the query for CPU in <strong>Tab 3</strong>. You should see the last published value - this is because we have cached the recent value in Redis</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-graphql line-numbers\"><code class=\"language-graphql\"><span class=\"token keyword\">query</span> <span class=\"token punctuation\">{</span>\n  cpu <span class=\"token punctuation\">{</span>\n    percentage\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-json line-numbers\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"data\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"cpu\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"percentage\"</span><span class=\"token operator\">:</span> <span class=\"token number\">25</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3>Client</h3>\n<p>Create a new React application using <code class=\"language-text\">create-react-app</code> for client</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sh line-numbers\"><code class=\"language-sh\">yarn create react-app client</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Install the required dependencies.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-sh line-numbers\"><code class=\"language-sh\">yarn add apollo-boost apollo-client apollo-link-ws graphql react-apollo subscriptions-transport-ws</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Setup Apollo HTTP client and websocket client, since we need both type of connection to the server. HTTP server will be running at <code class=\"language-text\">http://localhost:4000</code> and websocket subscription server at <code class=\"language-text\">ws://localhost:4000/graphql</code>.</p>\n<p><strong><a href=\"https://github.com/nowke/realtime-dashboard-demo/blob/master/client/src/App.js\"><code class=\"language-text\">client/src/App.js</code></a></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Component <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ApolloClient <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-client\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> InMemoryCache <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-cache-inmemory\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ApolloProvider <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react-apollo\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> split <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-link\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> HttpLink <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-link-http\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> WebSocketLink <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-link-ws\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getMainDefinition <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"apollo-utilities\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token string\">'./App.css'</span>\n<span class=\"token keyword\">import</span> Home <span class=\"token keyword\">from</span> <span class=\"token string\">\"./Pages/Home\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Create an http link:</span>\n<span class=\"token keyword\">const</span> httpLink <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  uri<span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://localhost:4000\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Create a WebSocket link:</span>\n<span class=\"token keyword\">const</span> wsLink <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebSocketLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  uri<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`ws://localhost:4000/graphql`</span></span><span class=\"token punctuation\">,</span>\n  options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    reconnect<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// using the ability to split links, you can send data to each link</span>\n<span class=\"token comment\">// depending on what kind of operation is being sent</span>\n<span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> <span class=\"token function\">split</span><span class=\"token punctuation\">(</span>\n  <span class=\"token comment\">// split based on operation type</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> query <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> kind<span class=\"token punctuation\">,</span> operation <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">getMainDefinition</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> kind <span class=\"token operator\">===</span> <span class=\"token string\">\"OperationDefinition\"</span> <span class=\"token operator\">&amp;&amp;</span> operation <span class=\"token operator\">===</span> <span class=\"token string\">\"subscription\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  wsLink<span class=\"token punctuation\">,</span>\n  httpLink\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  link<span class=\"token punctuation\">,</span>\n  cache<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InMemoryCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ApolloProvider</span> <span class=\"token attr-name\">client</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>client<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Home</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ApolloProvider</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>We have wrapped our <code class=\"language-text\">Home</code> component with <code class=\"language-text\">ApolloProvider</code>, which enables us to run queries and subscriptions.</p>\n<p>Let us design CPU usage component - <a href=\"https://github.com/nowke/realtime-dashboard-demo/blob/master/client/src/components/CpuUsage.js\">CpuUsage.js</a>.</p>\n<p>Define the query and subscription</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> gql <span class=\"token keyword\">from</span> <span class=\"token string\">\"graphql-tag\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">QUERY</span> <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  query CPU {\n    cpu {\n      percentage\n    }\n  }\n`</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SUBSCRIPTION</span> <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token string\">`\n  subscription CPU {\n    cpu {\n      percentage\n    }\n  }\n`</span></span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Our requirement is as follows.</p>\n<ul>\n<li>On initial load, data should be rendered via <code class=\"language-text\">query</code></li>\n<li>Post load, component should render the value from subscription</li>\n</ul>\n<p>This can be achieved using <code class=\"language-text\">subscribeToMore</code> prop given by <code class=\"language-text\">Query</code> component in <code class=\"language-text\">react-apollo</code> - <a href=\"https://www.apollographql.com/docs/react/advanced/subscriptions.html#subscribe-to-more\">https://www.apollographql.com/docs/react/advanced/subscriptions.html#subscribe-to-more</a></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Component <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Query <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react-apollo\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">CpuUsageContainer</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Query</span> <span class=\"token attr-name\">query</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token constant\">QUERY</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> subscribeToMore<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>result <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>CpuUsage</span>\n        <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">...</span><span class=\"token attr-value\">result</span><span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">subscribeToNewData</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n          <span class=\"token function\">subscribeToMore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            document<span class=\"token punctuation\">:</span> <span class=\"token constant\">SUBSCRIPTION</span><span class=\"token punctuation\">,</span>\n            updateQuery<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>prev<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> subscriptionData <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>subscriptionData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> prev<span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">return</span> subscriptionData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">/></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Query</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Display CPU percentage inside <code class=\"language-text\">CpuUsage</code> component.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">CpuUsage</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span><span class=\"token function\">subscribeToNewData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">,</span> loading <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>loading<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> Loading ... </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Error!</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> CPU Usage: </span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">.</span>cpu<span class=\"token punctuation\">.</span>percentage<span class=\"token punctuation\">}</span><span class=\"token plain-text\">% </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Refer the file <a href=\"https://github.com/nowke/realtime-dashboard-demo/blob/master/client/src/components/CpuUsage.js\">CpuUsage.js</a> for complete class definition with Pie chart</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/25fc9396db647a3270c468e3a1ff26c8/37844/cpu.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 347px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 103.45821325648417%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAACMUlEQVQ4y7VUTWgTQRhd8C6Cip4F0SJYUFDE+BOpeCvYGvAmQvWkF03VUqjWWqHWWsWCBymiEfJjJI272FWDHtSDSqVUSghRVAykCoY2TXY3mZ19zk6SZTf9cS31Wx47++bN4+3MxwiqqmG2UFwWFBiE6Zk8KDVAiA6izw+doUzKKFVBCOGcpWFrKaUoFBUI+dkCllLUoHM4VdMgzOQrhoZhzIvaQulLArfHhjE2NcE4g3M6m6vpzFLUOsP6shsOTwTROtKGprAPJ5+1Y/znpJXUtWE9r5ESxn9N4nSiEwdCR5D49rqSlOruE9q3w15974Z42uTvzxUNexY1rDer/T6hxOLb5LPwv+q21rhOWM/VTF9+fwNvqBVfp3/w76Ki/D2hwkS5XI5DY21hn1OJhreZDyiWlWpCdWFDs1HNSqVSEEURkiRBlmXe0Auld7WH2WwWyWQSmUwG6XTakdKEecL/1IeLtZL9wFwndJwypQ5+zn67aWw39X8NzeuL91b1mloKzLXW9aVpJSxnCY+lFzjV0YvzPTfQ3j1QwaXruHBlkI3Zu2cQXX1D6Oi9yTn/xX742bylZTjHcKbrGi4P3IHQefUWVqzfinVb9mH1Jg/WbPZg1cZdaPA0w3v4OHYcOortTT407m/BNvY+6DuBvc3HsLZhD9Pv5npzvHLDTjR6WyC8//gJdwNRBCJPcD8cdyAUG0Uw9pSPA49EPIyKiMRlhEdGHboHkTjuBWOIis/xBxooB7yFLBzFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"CPU Usage\"\n        title=\"\"\n        src=\"/static/25fc9396db647a3270c468e3a1ff26c8/37844/cpu.png\"\n        srcset=\"/static/25fc9396db647a3270c468e3a1ff26c8/95c64/cpu.png 148w,\n/static/25fc9396db647a3270c468e3a1ff26c8/0d14f/cpu.png 295w,\n/static/25fc9396db647a3270c468e3a1ff26c8/37844/cpu.png 347w\"\n        sizes=\"(max-width: 347px) 100vw, 347px\"\n      />\n  </span>\n  </a></p>\n<h3>Worker</h3>\n<p>Let us write a small script that mocks real events by calling mutation for 4 panels at regular intervals. We will use <a href=\"https://www.npmjs.com/package/node-schedule\">node-schedule</a> package.</p>\n<p>Install the dependencies</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">yarn add node-schedule request request-promise</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Define the mutations for each panels</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> queries <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">CPU</span><span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`\n    mutation {\n      cpu {\n        percentage\n      }\n    }\n    `</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">TRAFFIC</span><span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`\n    mutation {\n      traffic {\n        total\n        dps {\n          timestamp\n          value\n        }\n      }\n    }\n    `</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">DISTRIBUTION</span><span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`\n    mutation {\n      distribution {\n        region\n        percentage\n      }\n    }\n    `</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">MESSAGES</span><span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`\n    mutation {\n      messages {\n        title\n        description\n        color\n      }\n    }\n    `</span></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>For example, add a scheduler for CPU using <code class=\"language-text\">schedule.scheduleJob</code> for every 3 seconds</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> schedule <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"node-schedule\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nschedule<span class=\"token punctuation\">.</span><span class=\"token function\">scheduleJob</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"*/3 * * * * *\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">makeHttpRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CPU\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Call mutation for CPU panel</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Fetched new results for CPU\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Refer <a href=\"https://github.com/nowke/realtime-dashboard-demo/blob/master/worker/worker.js\">worker/worker.js</a> for complete script</p>\n<p>Run the worker</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">$ yarn start\nyarn run v1.13.0\n$ node worker.js\nStarting worker\nScheduled Jobs for CPU, Traffic, distribution, messages\nFetched new results for TRAFFIC\nFetched new results for MESSAGES\nFetched new results for CPU\nFetched new results for DISTRIBUTION\nFetched new results for CPU\nFetched new results for MESSAGES\nFetched new results for TRAFFIC\n...\n...</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<img src=\"/demo-c4fc92aed4a93e02edf4e7e71dd700e5.gif\" alt=\"Real-time dashboard preview\" style=\"border: 1px solid #000;\">\n<h2>Scaling</h2>\n<p>For high-availability, server will be deployed in multiple instances connected using Load-balancer. </p>\n<p>Consider 4 servers <code class=\"language-text\">server1</code>, <code class=\"language-text\">server2</code>, <code class=\"language-text\">server3</code> and <code class=\"language-text\">server4</code>. When a user opens the browser (client), it can connect to any of the servers via load-balancer. All of these servers are connected to a redis cluster <code class=\"language-text\">redis-cluster</code></p>\n<p>If nginx is used, routing websocket requests is possible by changing the configuration. Refer <a href=\"https://www.nginx.com/blog/websocket-nginx/\">www.nginx.com/blog/websocket-nginx/</a> for details.</p>\n<h3>Architecture diagram</h3>\n<p>The following diagram represents where 4 clients are connected to 4 servers via load-balancer</p>\n<p><img src=\"/arch-diagram-1ee36dfd846a36d6f1e0381a76234eb0.svg\" alt=\"Architecture diagram\"></p>\n<p>Analyzing a request flow from <strong>Worker</strong>,</p>\n<p><img src=\"/request-analysis-2c1a3c8c89e33548d823eb6e8388f567.svg\" alt=\"Request analysis\"></p>\n<ol>\n<li>Worker makes a <strong><code class=\"language-text\">POST</code></strong> request (a <strong>mutation</strong>) to one of the servers (via <strong>load balancer</strong>), say <code class=\"language-text\">server1</code></li>\n<li><strong><code class=\"language-text\">server1</code></strong> sends <strong><code class=\"language-text\">PUBLISH</code></strong> command to redis cluster with data for <code class=\"language-text\">cpu</code></li>\n<li>Since all servers are subscribed to same channel in redis, all of them receive data for <code class=\"language-text\">cpu</code></li>\n<li>Servers publish the data via websocket to all the clients.</li>\n</ol>","frontmatter":{"title":"Real-time Dashboard","description":"A lightweight scalable real-time dashboard using React, GraphQL subscriptions and Redis PubSub"}}},"pageContext":{"slug":"/realtime-dashboard/"}}